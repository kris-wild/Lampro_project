---
title: "Results"
author: Kristoffer Wild
date: "`r Sys.Date()`"
output: 
  word_document:
    reference_docx: template.docx
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE, eval = T, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
options(digits = 2)
rm(list=ls())
sessionInfo()
# Packages
pacman::p_load("dplyr", "MASS", "brms", "bayestestR", "MCMCglmm", "quantreg","lmerTest", "emmeans", "latex2exp", "DHARMa", "tidybayes", "ggeffects", "bayesplot", "rstanarm", "plotrix", "emmeans", "patchwork", "ggExtra", "sjPlot", "kableExtra","flextable", "orchaRd", "ggplot2")
```
# Results
```{r TprefCTmaxResults, echo = FALSE, include = FALSE}
## Tpref raw data
Tpref <- read.csv("~/Dropbox/Lampro_project/Final.Analysis.Data/Tpref_datasheet_2020.csv")  %>% 
  mutate(Incubation_temp = gsub("[AC]-", "", trt),
         Yolk_treat = gsub("-.*", "", trt)) %>% 
  rename(id = "bd_liz_id",
         Tpref = "mean_temp") %>% 
  mutate(Inc_temp = as.character(Incubation_temp))

# summary
Tpref.Range <- Tpref %>% 
  summarise(n = n(),
            min = min(Tpref),
            max = max(Tpref), 
            mean = mean(Tpref)) %>% 
  round(2)

# CTmax
CT.data.raw <- read.csv("~/Dropbox/Lampro_project/Final.Analysis.Data/CTmax_datasheet_2020.csv") %>%
  mutate(Incubation_temp = gsub("[AC]-", "", trt),
         Yolk_treat = gsub("-.*", "", trt)) %>% 
  rename(id = "bd_liz_id") %>% 
  mutate(Inc_temp = as.character(Incubation_temp))
# summary
CTmax.Range <- CT.data.raw %>% 
  summarise(min = min(CTmax),
            max = max(CTmax), 
            mean = mean(CTmax)) %>% 
  round(2)
```
*(a)Incubation temperature and resource allocation consequences on thermal preference and critical thermal maximum*
<p>Hatchling *Lampropholis delicata* mean thermal preference (T$_{pref}$) was `r Tpref.Range[1,4]`$^\circ$C and ranged from `r Tpref.Range[1,2]`–`r Tpref.Range[1,3]`$^\circ$C. Mean critical thermal maximum (CT$_{max}$) was `r CTmax.Range[1,3]`$^\circ$C and ranged from `r CTmax.Range[1,1]`–`r CTmax.Range[1,2]`$^\circ$C. We did not detect any effect of incubation temperature, yolk treatment, sex, or body mass on T$_{pref}$ or CT$_{max}$ (Figure 1A|B; Table 1). The WAIC model comparisons further support these findings, where our null model ranked as the most parsimonious over other model combinations for both T$_{pref}$ or CT$_{max}$ (Table S1) <p>
```{r MetaAnalysisResults, echo = FALSE, include = FALSE}
# overall mod
model_all_rand <- readRDS("~/Dropbox/Lampro_project/Final.Models/Meta_analysis_models/Meta_mods_accl_ratio/meta.acc.no.phylo.rds")
I2_all <- as.data.frame(round(i2_ml(model_all_rand),digits = 3))
# spp mod
spp_mod <- readRDS("~/Dropbox/Lampro_project/Final.Models/Meta_analysis_models/Meta_mods_accl_ratio/meta.acc.spp.rds")
I2_spp <- as.data.frame(round(i2_ml(spp_mod),digits = 3))
```
*(b)	Meta-analysis of early thermal effects on thermal physiology in reptiles*
<p>Accounting for n = 69 measured effects measured across 13 reptile species, developmental temperatures did not influence thermal traits (T$_{pref}$ or CT$_{max}$) in reptiles overall (HPD: Fig. 2A). When investigating moderators, we found that thermal traits were not influenced across life stage or latitude (Fig. 2B|C). When analysing each reptilian taxonomic group separately, there was no variation in thermal traits for lizards, tortoise, tuataras, and turtles. However, there were a significant increase in thermal traits in snakes (Fig 2D). Heterogeneity in the data was high ($I^2_{Total}$ = `r I2_all[1,1]`%), with species effects ($I^2_{Species}$ = `r I2_spp[1,1]`%) driving the majority of heterogeneity. Upon investigating species specific responses only *Chelydra serpentina* and *Nerodia sipedon* were the only species with significant thermal trait responses to incubation temperatures (Fig. S2). Under higher developmental temperatures, thermal traits in *C. serpentina* decline by 7% while thermal traits in *N. sipedon* increase by 20%. We found no evidence for publication bias (Fig S3; *for details see electronic supplementary materials*).<p>

\newpage
# Tables & Figures
Table 1. Model outputs coefficients for testing wither sex, body mass, incubation temperature, resource, or the interaction between resource and temperature had an effect on T$_{Pref}$ or CT$_{Max}$ in hatchling *Lampropholis delicata*. Est. value describes the estimated coefficient value and 95% CI describes the lower and upper bound of the 95% credible interval for each coefficient value. Intercept is the estimated mean of each thermal trait from the null model. 
```{r Table1,echo= FALSE}
################ Tpref
# Tabulate the model coefficients
#null mod
Tpref_m1 <- readRDS(file = "~/Dropbox/Lampro_project/Final.Models/Tpref_models/Tpref.m1.rds")
Tpref_m1_table <- lazerhawk::brms_SummaryTable(Tpref_m1)
# M2 = sex
Tpref_m2 <- readRDS(file = "~/Dropbox/Lampro_project/Final.Models/Tpref_models/Tpref.m2.rds")
Tpref_m2_table <- lazerhawk::brms_SummaryTable(Tpref_m2) %>% 
  filter(Covariate == "sexm") 
Tpref_m2_table[1,1] <- "Sex"
# M3 = body mass
Tpref_m3 <- readRDS(file = "~/Dropbox/Lampro_project/Final.Models/Tpref_models/Tpref.m3.rds")
Tpref_m3_table <- lazerhawk::brms_SummaryTable(Tpref_m3) %>% 
  filter(Covariate == "scalebody_size") 
Tpref_m3_table[1,1] <- "Body Mass"
# M4 = Incubation Temperature
Tpref_m4 <- readRDS(file = "~/Dropbox/Lampro_project/Final.Models/Tpref_models/Tpref.m4.rds")
Tpref_m4_table <- lazerhawk::brms_SummaryTable(Tpref_m4) %>% 
  filter(Covariate == "temp28") 
Tpref_m4_table[1,1] <- "Incubation Temperature"
# M5 = Resource
Tpref_m5 <- readRDS(file = "~/Dropbox/Lampro_project/Final.Models/Tpref_models/Tpref.m5.rds")
Tpref_m5_table <- lazerhawk::brms_SummaryTable(Tpref_m5) %>% 
  filter(Covariate == "treatC") 
Tpref_m5_table[1,1] <- "Resource"
# M6 = Resource*Temp interaction
Tpref_m6 <- readRDS(file = "~/Dropbox/Lampro_project/Final.Models/Tpref_models/Tpref.m6.rds")
Tpref_m6_table <- lazerhawk::brms_SummaryTable(Tpref_m6) %>% 
  filter(Covariate == "temp28:treatC") 
Tpref_m6_table[1,1] <- "Incubation Temperature*Resource"

# arranging Tpref Table
Tpref.Tbl.comb <- rbind(Tpref_m1_table, Tpref_m2_table, Tpref_m3_table, 
               Tpref_m4_table, Tpref_m5_table, Tpref_m6_table) %>% 
  dplyr::select(c(-Est.Error)) %>% 
  mutate("Thermal Index" = "Tpref")
Tpref.Tbl.1 <- Tpref.Tbl.comb[,c(5,1,2,3,4)]

################ CT MAX
# Tabulate the model coefficients 
#null mod
CTmax_m1 <- readRDS(file = "~/Dropbox/Lampro_project/Final.Models/CTmax_models/CT.Max.m1.rds")
CTmax_m1_table <- lazerhawk::brms_SummaryTable(CTmax_m1)
# M2 = sex
CTmax_m2 <- readRDS(file = "~/Dropbox/Lampro_project/Final.Models/CTmax_models/CT.Max.m2.rds")
CTmax_m2_table <- lazerhawk::brms_SummaryTable(CTmax_m2) %>% 
  filter(Covariate == "sexm") 
CTmax_m2_table[1,1] <- "Sex"
# M3 = body mass
CTmax_m3 <- readRDS(file = "~/Dropbox/Lampro_project/Final.Models/CTmax_models/CT.Max.m3.rds")
CTmax_m3_table <- lazerhawk::brms_SummaryTable(CTmax_m3) %>% 
  filter(Covariate == "scalemass") 
CTmax_m3_table[1,1] <- "Body Mass"
# M4 = Incubation Temperature
CTmax_m4 <- readRDS(file = "~/Dropbox/Lampro_project/Final.Models/CTmax_models/CT.Max.m4.rds")
CTmax_m4_table <- lazerhawk::brms_SummaryTable(CTmax_m4) %>% 
  filter(Covariate == "temp28") 
CTmax_m4_table[1,1] <- "Incubation Temperature"
# m5 = Resource
CTmax_m5 <- readRDS(file = "~/Dropbox/Lampro_project/Final.Models/CTmax_models/CT.Max.m5.rds")
CTmax_m5_table <- lazerhawk::brms_SummaryTable(CTmax_m5) %>% 
  filter(Covariate == "treatC") 
CTmax_m5_table[1,1] <- "Resource"
# m6 = Resource*Temp interaction
CTmax_m6 <- readRDS(file = "~/Dropbox/Lampro_project/Final.Models/CTmax_models/CT.Max.m6.rds")
CTmax_m6_table <- lazerhawk::brms_SummaryTable(CTmax_m6) %>% 
  filter(Covariate == "temp28:treatC") 
CTmax_m6_table[1,1] <- "Incubation Temperature*Resource"

# arranging CTmax Table
CTmax.Tbl.comb <- rbind(CTmax_m1_table, CTmax_m2_table, CTmax_m3_table, 
               CTmax_m4_table, CTmax_m5_table, CTmax_m6_table) %>% 
  dplyr::select(-c(Est.Error)) %>% 
  mutate("Thermal Index" = "CTmax")
CTmax.Tbl.1 <- CTmax.Tbl.comb[,c(5,1,2,3,4)]

############# Final Table 1
Tbl.1 <- as.data.frame(rbind(Tpref.Tbl.1, CTmax.Tbl.1))
Tbl.1.Final <- flextable(Tbl.1) %>% 
  italic(i = 1:12, j = 1, italic = TRUE) %>% 
  bold(i = 1, j = 2:5, bold = TRUE, part = "body") %>% 
  bold(i = 7, j = 2:5, bold = TRUE, part = "body") %>% 
  hline(i=6, j = 1:5, part="body") %>% 
  merge_v(j = "Thermal Index") %>%  
  autofit(part = "all") %>% 
  align(align ="center", part = "all") %>% 
  font(part = "all", fontname = "Times New Roman") %>% 
  fix_border_issues() 
knitr::knit_print(Tbl.1.Final)
```

\newpage
```{r Fig1AB,echo= FALSE}
# Figure 1 - code for figure can be found in Thermal_gradient.R script
knitr::include_graphics("~/Dropbox/Lampro_project/Final.Figures/Figure1.pdf")
```
Figure 1. Thermal indices across different incubation temperatures and resource treatments for hatchling *Lampropholis delicata* (n=10 per temperature and treatment). (A) Thermal preference (T$_{pref}$) in lizards incubated at 23 & 28°C for each resource treatment (yolk ablation & control). (B) Critical thermal maximum (CT$_{max}$) in lizards incubated at 23 & 28°C for each resource treatment. Bars above plots indicate pairwise comparisons of thermal indices between treatment temperature and the interaction between treatment temperature and resource treatment. 

\newpage
```{r Fig2ABCD,echo= FALSE}
# Figure 2 - - code for figure can be found in meta-analysis.R script s
knitr::include_graphics("~/Dropbox/Lampro_project/Final.Figures/Figure2.pdf")
```
Figure 2. Magnitude of the effect on developmental temperature on thermal indices (T$_{pref}$ & CT$_{max}$) in reptiles (A) with respect to age class (B), latitude (C), and taxon (D). Mean meta-analytic estimates (circles) with their 95% confidence intervals (thicker error bars) and prediction intervals (thinner error bars). Individual data points (colored circles) from each study from meta-analysis are scaled by precision (inverse of standard error) and k is the number of effect sizes with number of species in brackets. ARR is acclimation response ratio. Graphs were constructed using the orchaRd package (Nakagawa et al., 2021; version 2.0).

\newpage
# Supplementary Tables 
Table S1. S1. Loo criterion of BRMS model fit for each thermal metric (T$_{Pref}$ or CT$_{Max}$) when accounting for s (sex), m (mass), r (resource), t (temperature), and rxt interaction in hatchling *Lampropholis delicata*. The expected log-wise predictive density is elpd_diff and se_diff is the standard error associated with the elpd. 
```{r TableS1,echo= FALSE}
################ Tpref
Tpref_m1 <-readRDS(file = "~/Dropbox/Lampro_project/Final.Models/Tpref_models/Tpref.m1.rds")
Tpref_m2 <-readRDS(file = "~/Dropbox/Lampro_project/Final.Models/Tpref_models/Tpref.m2.rds")
Tpref_m3 <-readRDS(file = "~/Dropbox/Lampro_project/Final.Models/Tpref_models/Tpref.m3.rds")
Tpref_m4 <-readRDS(file = "~/Dropbox/Lampro_project/Final.Models/Tpref_models/Tpref.m4.rds")
Tpref_m5 <-readRDS(file = "~/Dropbox/Lampro_project/Final.Models/Tpref_models/Tpref.m5.rds")
Tpref_m6 <-readRDS(file = "~/Dropbox/Lampro_project/Final.Models/Tpref_models/Tpref.m6.rds")

# loo comparison for t pref
Tpref_loo <- loo(Tpref_m1, Tpref_m2, Tpref_m3, Tpref_m4, Tpref_m5, Tpref_m6)
Tpref_loo_df <- as.data.frame(Tpref_loo$diffs) %>% 
  round(digits = 3) %>% 
  dplyr::select("elpd_diff", "se_diff") %>% 
  mutate("Model Expression" = "1",
         "Thermal Index" = "Tpref")
Tpref_loo_df[1,3] <- "Tpref~1"
Tpref_loo_df[2,3] <- "Tpref~s"
Tpref_loo_df[3,3] <- "Tpref~m"
Tpref_loo_df[4,3] <- "Tpref~t"
Tpref_loo_df[5,3] <- "Tpref~r"
Tpref_loo_df[6,3] <- "Tpref~r*t"
Tpref_loo_df <- Tpref_loo_df[,c(4,3,1,2)]

################ CT Max
CT_m1 <-readRDS(file = "~/Dropbox/Lampro_project/Final.Models/CTmax_models/CT.Max.m1.rds")
CT_m2 <-readRDS(file = "~/Dropbox/Lampro_project/Final.Models/CTmax_models/CT.Max.m2.rds")
CT_m3 <-readRDS(file = "~/Dropbox/Lampro_project/Final.Models/CTmax_models/CT.Max.m3.rds")
CT_m4 <-readRDS(file = "~/Dropbox/Lampro_project/Final.Models/CTmax_models/CT.Max.m4.rds")
CT_m5 <-readRDS(file = "~/Dropbox/Lampro_project/Final.Models/CTmax_models/CT.Max.m5.rds")
CT_m6 <-readRDS(file = "~/Dropbox/Lampro_project/Final.Models/CTmax_models/CT.Max.m6.rds")
CT_loo <- loo(CT_m1, CT_m2, CT_m3, CT_m4, CT_m5, CT_m6)
CT_loo_df <- as.data.frame(CT_loo$diffs) %>% 
  round(digits = 3)%>% 
  dplyr::select("elpd_diff", "se_diff") %>% 
  mutate("Model Expression" = "1",
         "Thermal Index" = "CTmax")
CT_loo_df[1,3] <- "CTmax~1"
CT_loo_df[2,3] <- "CTmax~s"
CT_loo_df[3,3] <- "CTmax~m"
CT_loo_df[4,3] <- "CTmax~t"
CT_loo_df[5,3] <- "CTmax~r"
CT_loo_df[6,3] <- "CTmax~r*t"
CT_loo_df <- CT_loo_df[,c(4,3,1,2)]

############# Final Table S1
Tbl.S1 <- rbind(Tpref_loo_df, CT_loo_df)
Tbl.S1.Final <- flextable(Tbl.S1) %>%
  italic(i = 1:10, j = 1, italic = TRUE) %>% 
  merge_v(j = "Thermal Index") %>%  
  hline(i=6, j = 1:4, part="body") %>%  
  autofit(part = "all") %>% 
  align(align ="center", part = "all") %>% 
  font(part = "all", fontname = "Times New Roman") %>% 
  fix_border_issues() 
knitr::knit_print(Tbl.S1.Final)
```

\newpage
```{r FigS1,echo= FALSE}
# figure of lizard in tube
knitr::include_graphics("~/Dropbox/Lampro_project/Final.Figures/FigureS1.pdf")
```
Figure S1.XXXXXXXXXXXXXXXXXX

\newpage
```{r FigS2,echo= FALSE}
# Figure S2 - code for figure can be found in meta-analysis.R script
knitr::include_graphics("~/Dropbox/Lampro_project/Final.Figures/FigureS2.pdf")
```
Figure S2. Magnitude of the effect on developmental temperature on thermal indices (T$_{pref}$ & CT$_{max}$) in species. ARR is acclimation response ratio. Mean meta-analytic estimates (circles) with their 95% confidence intervals (thicker error bars) and prediction intervals (thinner error bars). Individual data points (colored circles) from each study from meta-analysis are scaled by precision (inverse of standard error) and k is the number of effect sizes with number of species in brackets. Graphs were constructed using the orchaRd package (Nakagawa et al., 2021; version 2.0).

\newpage
```{r FigS3,echo= FALSE}
# Figure S3 - code for figure can be found in meta-analysis.R script
knitr::include_graphics("~/Dropbox/Lampro_project/Final.Figures/FigureS3.pdf")
```
Figure S3. Funnel plot of the meta-analytic residuals against precision (1/SE). Each point represents a pair-wise temperature comparison. There is no visually detectable asymmetry.